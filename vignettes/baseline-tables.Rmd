---
title: "Baseline Characteristics Tables"
description: >
  Create demographics, medical history, and baseline characteristic tables
  for clinical study reports using ADaM datasets.
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Baseline Characteristics Tables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

## Introduction

Baseline tables show participant demographics, medical history, and enrollment data at randomization.

## Setup

```{r setup}
library(pharmhand)
library(dplyr)
library(pharmaverseadam)

# Set flextable defaults for readable tables in light/dark mode
flextable::set_flextable_defaults(
  font.color = "#000000",
  background.color = "#FFFFFF"
)

# Load example data
adsl <- pharmaverseadam::adsl
admh <- pharmaverseadam::admh
adcm <- pharmaverseadam::adcm
```

## Demographics table

The demographics table presents basic participant characteristics including age, sex, and ethnicity.

### Simple approach: Pass data.frame directly

```{r demographics-basic}
# Simplest: pass data.frame directly (auto-coerced)
demo_table <- create_demographics_table(adsl)

# Display the table
demo_table@flextable
```

The function automatically wraps the data.frame in an ADaMData object.

### Advanced approach: Explicit ADaMData for population filtering

For population filtering, create an ADaMData object explicitly:

```{r adam-data}
# Wrap ADSL with population filtering
adam_data <- ADaMData(
  data = adsl,
  domain = "ADSL",
  population = "SAF"
)

# Pass to table function
demo_table_saf <- create_demographics_table(
  adsl_data = adam_data,
  trt_var = "TRT01P"
)
```

Customize variable names to match your data structure:

```{r demographics-custom}
# Custom variable names
demo_table_custom <- create_demographics_table(
  adsl_data = adam_data,
  trt_var = "TRT01P",
  age_var = "AGE",
  sex_var = "SEX",
  ethnic_var = "ETHNIC"
)

# Display the table
demo_table_custom@flextable
```

## Enrollment by region

```{r region-table}
region_table <- create_region_table(
  adsl = adsl,
  trt_var = "TRT01P",
  region_var = "REGION1"
)

# Display the table
region_table@flextable
```

## Medical history

<details>
<summary>Click to expand: Medical History Table</summary>

```{r medical-history}
mh_table <- create_medical_history_table(
  adsl = adsl,
  admh = admh,
  trt_var = "TRT01P",
  soc_var = "MHBODSYS"
)

# Display the table
mh_table@flextable
```

</details>

## Concomitant medications

<details>
<summary>Click to expand: Concomitant Medications Table</summary>

```{r conmeds}
cm_table <- create_conmeds_table(
  adsl = adsl,
  adcm = adcm,
  trt_var = "TRT01P"
)

# Display the table
cm_table@flextable
```

</details>

## Disposition

Disposition tables summarize participant flow through study phases and reasons for discontinuation.

```{r disposition}
disp_table <- create_disposition_table(
  adsl = adsl,
  trt_var = "TRT01P"
)

# Display the table
disp_table@flextable
```

## Population summary

Population summary tables provide counts and percentages for different analysis populations.

```{r population-summary}
pop_table <- create_population_summary_table(
  adsl = adsl,
  trt_var = "TRT01P",
  pop_flags = c("SAFFL"),
  pop_labels = c("Safety")
)

# Display the table
pop_table@flextable
```

## Baseline Balance Assessment (SMD)

For GBA/AMNOG dossiers and other regulatory submissions, assessing baseline balance between treatment groups is critical. The standardized mean difference (SMD) provides a standardized measure of covariate balance that is independent of sample size.

### Calculating SMD for individual variables

```{r smd-individual}
# Calculate SMD for a continuous variable
smd_age <- calculate_smd_from_data(
  data = adsl,
  var = "AGE",
  trt_var = "TRT01P",
  ref_group = "Placebo"
)

# View SMD result
cat("Age SMD:", round(smd_age$smd, 3),
    "95% CI: (", round(smd_age$ci_lower, 3), ",",
    round(smd_age$ci_upper, 3), ")\n")

# Calculate SMD for a categorical variable
smd_sex <- calculate_smd_from_data(
  data = adsl,
  var = "SEX",
  trt_var = "TRT01P",
  ref_group = "Placebo"
)

cat("Sex SMD:", round(smd_sex$smd, 3), "\n")
```

### Comprehensive balance assessment

Use `assess_baseline_balance()` for a complete assessment of multiple variables:

```{r balance-assessment}
# Assess balance for continuous and categorical variables
balance <- assess_baseline_balance(
  data = adsl,
  trt_var = "TRT01P",
  continuous_vars = c("AGE"),
  categorical_vars = c("SEX", "RACE", "ETHNIC"),
  ref_group = "Placebo",
  threshold = 0.1  # Standard threshold for imbalance
)

# Check overall balance
cat("Number of variables assessed:", balance@n_vars, "\n")
cat("Number of imbalanced variables (|SMD| > 0.1):", balance@n_imbalanced, "\n")
cat("Overall balanced:", balance@balanced, "\n")

# View imbalanced variables (if any)
if (length(balance@imbalanced_vars) > 0) {
  imbalanced <- paste(balance@imbalanced_vars, collapse = ", ")
  cat("Imbalanced variables:", imbalanced, "\n")
}
```

### SMD table for demographics

Add SMD values directly to your demographics table data:

```{r smd-table}
# Generate SMD table
smd_results <- add_smd_to_table(
  data = adsl,
  trt_var = "TRT01P",
  vars = c("AGE", "SEX", "RACE", "ETHNIC"),
  ref_group = "Placebo",
  threshold = 0.1
)

# View the results
smd_results |>
  dplyr::select(variable, smd_display, ci, var_type, imbalanced)
```

### Love Plot visualization

A Love plot (covariate balance plot) provides a visual summary of balance across all covariates:

```{r love-plot, fig.width=8, fig.height=5}
# Create Love plot from balance assessment
love_plot <- create_love_plot(
  balance_assessment = balance,
  threshold = 0.1,
  title = "Baseline Covariate Balance",
  show_ci = TRUE
)

# Display the plot
love_plot@plot
```

Variables with |SMD| > 0.1 (outside the dashed lines) may indicate meaningful imbalance that should be discussed or adjusted for in sensitivity analyses.

## Combining into a report

Combine baseline tables into a report.

```{r combine-report, eval = FALSE}
# Create report sections
demo_section <- ReportSection(
  title = "Demographics",
  content = demo_table
)

region_section <- ReportSection(
  title = "Enrollment by Region",
  content = region_table
)

mh_section <- ReportSection(
  title = "Medical History",
  content = mh_table
)

# cm_section <- ReportSection(
#   title = "Concomitant Medications",
#   content = cm_table
# )

# Create clinical report
report <- ClinicalReport(
  title = "Baseline Characteristics",
  sections = list(
    demo_section,
    region_section,
    mh_section
  )
)

# Generate Word document
generate_word(report, path = tempfile(fileext = ".docx"))
```

The Word document contains formatted baseline tables.
