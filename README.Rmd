---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# pharmhand <img src="man/figures/logo.png" align="right" height="139" alt="pharmhand logo" />

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R-CMD-check](https://github.com/sims1253/pharmhand/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/sims1253/pharmhand/actions/workflows/R-CMD-check.yaml)
[![Codecov test coverage](https://codecov.io/gh/sims1253/pharmhand/graph/badge.svg)](https://codecov.io/gh/sims1253/pharmhand)
[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)
[![pkgdown](https://github.com/sims1253/pharmhand/actions/workflows/pkgdown.yaml/badge.svg)](https://sims1253.github.io/pharmhand/)
<!-- badges: end -->

pharmhand creates clinical study tables and reports from ADaM datasets. It uses S7 classes to structure clinical data and outputs formatted tables and plots for Word documents.

## Installation

```r
# install.packages("pak")
pak::pak("sims1253/pharmhand")
```

## Examples

```{r example-setup, include=FALSE}
library(pharmhand)
library(pharmaverseadam)

adsl <- pharmaverseadam::adsl
adtte <- pharmaverseadam::adtte_onco
adae <- pharmaverseadam::adae
adrs <- pharmaverseadam::adrs_onco
```

### Demographics Table

```{r demo-table, message=FALSE, warning=FALSE}
adam_data <- ADaMData(data = adsl, trt_var = "TRT01P")
demo_table <- create_demographics_table(adam_data)
demo_table@flextable
```

### Kaplan-Meier Plot

```{r km-plot, message=FALSE, warning=FALSE, fig.width=8, fig.height=6}
km <- create_km_plot(
  data = adtte,
  time_var = "AVAL",
  event_var = "CNSR",
  trt_var = "ARM",
  title = "Kaplan-Meier Plot: Overall Survival",
  risk_table = TRUE,
  show_median = TRUE
)
km@plot
```

## Quick Start

```r
library(pharmhand)

# Wrap ADaM data with automatic population filtering
adam_data <- ADaMData(
  data = adsl,
  domain = "ADSL",
  population = "SAF",
  trt_var = "TRT01A"
)

# Access filtered data and treatment counts directly
adam_data@filtered_data  # Auto-filtered to SAFFL == "Y"
adam_data@trt_n          # Treatment group N's computed automatically
```

## Key Features

### Efficacy Tables

```r
# Time-to-event summary with median, HR, and landmarks
tte_table <- create_tte_summary_table(
  adtte,
  time_var = "AVAL",
  event_var = "CNSR",
  trt_var = "TRT01A",
  landmarks = c(6, 12)
)

# Responder analysis with CI, OR, RR, RD
responder_table <- create_responder_table(
  adrs,
  response_var = "AVALC",
  trt_var = "TRT01A",
  effect_measure = "OR"
)
```

### Safety Tables

```r
# AE Overview, by SOC, most common
create_ae_summary_table(adae, adsl, type = "overview")
create_ae_summary_table(adae, adsl, type = "soc")
create_ae_summary_table(adae, adsl, type = "common", n_top = 15)
```

### Report Generation

```r
# Build and export a complete report
report <- ClinicalReport(
  study_id = "STUDY-001",
  study_title = "Phase III Clinical Trial"
)

section <- ReportSection(title = "Efficacy Results", section_type = "efficacy")
section <- add_content(section, tte_table)
section <- add_content(section, km_plot)
report <- add_section(report, section)

generate_word(report, "study_report.docx")
```

### G-BA Module 4 Compliance

```r
# Create and validate G-BA compliant tables
module4_table <- create_hta_module4_table()
module4_table <- to_gba_template(module4_table)
check_gba_compliance(module4_table, strict = FALSE)
```

### Meta-Analysis & Evidence Synthesis

```{r meta-analysis-example, eval=FALSE}
# Random-effects meta-analysis
result <- meta_analysis(
  yi = log(c(0.75, 0.82, 0.68, 0.91, 0.77)),
  sei = c(0.12, 0.15, 0.18, 0.14, 0.11),
  study_labels = paste("Study", 1:5),
  effect_measure = "hr",
  model = "random"
)
result@estimate
result@heterogeneity$I2

# Forest plot
forest_plot <- create_meta_forest_plot(result, title = "Treatment Effect")
forest_plot@plot

# Network meta-analysis
nma_data <- data.frame(
  study = c("S1", "S2", "S3"),
  treat1 = c("A", "B", "A"),
  treat2 = c("B", "C", "C"),
  effect = log(c(0.75, 0.90, 0.80)),
  se = c(0.12, 0.15, 0.18)
)
nma_result <- network_meta(nma_data, effect_measure = "hr")
nma_result$summary
```

## Classes

- `ADaMData` - ADaM dataset wrapper with population filtering
- `Endpoint` / `HTAEndpoint` - Endpoint definitions for analyses
- `Study` - Base class with `SingleArmStudy`, `TwoArmStudy`, `MultiArmStudy`
- `StudySet` - Collection of studies for evidence synthesis
- `ClinicalTable` - Table with formatting
- `ClinicalPlot` - Plot with export settings
- `ClinicalReport` - Report with sections
- `StudyResult` - Container for single-study results
- `StatResult` - Statistical result base class (`ComparisonResult`, `MetaResult`)
- `EvidenceGrade` - IQWiG evidence grading result

## Related Packages

- [officer](https://davidgohel.github.io/officer/) - Word documents
- [flextable](https://davidgohel.github.io/flextable/) - Table formatting
- [admiral](https://pharmaverse.github.io/admiral/) - ADaM datasets
- [survival](https://cran.r-project.org/package=survival) - Survival analysis
- [chef](https://hta-pharma.github.io/chef/) - HTA analyses (optional)

## Learn More

- [Get Started](https://sims1253.github.io/pharmhand/articles/pharmhand.html)
- [Safety Tables](https://sims1253.github.io/pharmhand/articles/safety-tables.html)
- [Efficacy Tables](https://sims1253.github.io/pharmhand/articles/efficacy-tables.html)
- [Meta-Analysis](https://sims1253.github.io/pharmhand/articles/meta-analysis.html)
- [S7 Architecture](https://sims1253.github.io/pharmhand/articles/s7-architecture.html)

Browse the [full documentation](https://sims1253.github.io/pharmhand/).
