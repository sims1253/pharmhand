#' @title Adverse Event Summary Tables
#' @name safety_summary
#' @description Functions for creating AE summary tables in various formats.
NULL

# Standard AEACN value for drug discontinuation (CDISC controlled terminology)
AEACN_DRUG_WITHDRAWN <- "DRUG WITHDRAWN"

# Standard AEREL values indicating relationship to study drug
AEREL_RELATED_VALUES <- c(
	"PROBABLE",
	"POSSIBLE",
	"RELATED",
	"DEFINITELY RELATED"
)

#' Create Adverse Event Summary Table
#'
#' Generate AE summary tables for clinical study reports.
#'
#' @param data ADAE data frame or ADaMData object containing ADaM Adverse Events dataset
#' @param adsl ADSL data frame or ADaMData object (optional, required for some table types
#'   like "deaths", "comparison", or for denominator calculation)
#' @param type Character string specifying the table type:
#'   \itemize{
#'     \item "overview" - Summary of TEAEs, related AEs, SAEs, discontinuations
#'     \item "soc" - AEs by System Organ Class
#'     \item "soc_pt" - AEs by SOC and Preferred Term (hierarchical)
#'     \item "pt" - AEs by Preferred Term only
#'     \item "common" - Most frequently reported AEs
#'     \item "severity" - AEs by maximum severity
#'     \item "relationship" - AEs by relationship to study drug
#'     \item "sae" - Serious Adverse Events
#'     \item "discontinuation" - AEs leading to discontinuation
#'     \item "deaths" - Deaths summary (requires adsl)
#'     \item "comparison" - AE comparison with RD/RR (requires adsl)
#'   }
#' @param trt_var Treatment variable name (default: "TRT01P")
#' @param n_top For type="common", number of top PTs to show (default: 15)
#' @param soc For type="pt", filter to specific SOC (optional)
#' @param title Table title (auto-generated if NULL)
#' @param footnotes Character vector of footnotes (optional)
#' @param theme Theme for table styling (default: "hta")
#' @param ref_group For type="comparison", the reference group for comparisons
#' @param by For type="comparison", grouping level: "soc", "pt", or "overall"
#' @param threshold For type="comparison", minimum incidence pct (default: 0)
#' @param sort_by For type="comparison", sort by "rd", "rr", or "incidence"
#' @param conf_level For type="comparison", confidence level (default: 0.95)
#' @param include_nnh For type="comparison", include NNH column (default: TRUE)
#' @param soc_order For type="soc" or type="soc_pt", custom ordering of SOCs
#'   (character vector). If NULL, SOCs are sorted alphabetically (default: NULL)
#' @param severity_levels For type="severity", severity levels ordering
#'   (character vector). Default: c("MILD", "MODERATE", "SEVERE")
#' @param ... Additional arguments passed to [create_clinical_table()]
#'
#' @return A ClinicalTable object
#' @export
#'
#' @examples
#' \dontrun{
#' # AE Overview
#' overview <- create_ae_summary_table(data, adsl, type = "overview")
#'
#' # SOC table
#' soc_table <- create_ae_summary_table(data, adsl, type = "soc")
#'
#' # SOC/PT hierarchical table
#' soc_pt <- create_ae_summary_table(data, adsl, type = "soc_pt")
#'
#' # Most common AEs (top 20)
#' common <- create_ae_summary_table(data, adsl, type = "common", n_top = 20)
#'
#' # SAE table
#' sae <- create_ae_summary_table(data, adsl, type = "sae")
#'
#' # AE comparison with risk differences
#' comparison <- create_ae_summary_table(
#'   data, adsl,
#'   type = "comparison",
#'   ref_group = "Placebo",
#'   by = "pt",
#'   threshold = 5
#' )
#'
#' # SOC table with custom ordering
#' soc_ordered <- create_ae_summary_table(
#'   data, adsl,
#'   type = "soc",
#'   soc_order = c(
#'     "Infections",
#'     "Nervous system disorders",
#'     "Gastrointestinal disorders"
#'   )
#' )
#' }
create_ae_summary_table <- function(
	data,
	adsl = NULL,
	type = c(
		"overview",
		"soc",
		"soc_pt",
		"pt",
		"common",
		"severity",
		"relationship",
		"sae",
		"discontinuation",
		"deaths",
		"comparison"
	),
	trt_var = ph_default("trt_var"),
	n_top = ph_default("n_top"),
	soc = NULL,
	title = NULL,
	footnotes = character(),
	theme = "hta",
	ref_group = NULL,
	by = "pt",
	threshold = 0,
	sort_by = "incidence",
	conf_level = ph_default("conf_level"),
	include_nnh = TRUE,
	soc_order = NULL,
	severity_levels = c("MILD", "MODERATE", "SEVERE"),
	...
) {
	type <- match.arg(type)

	# Ensure ADaMData objects for consistent internal handling
	adae <- .ensure_adam_data(data, "ADAE")

	# Validate and ensure adsl if needed for specific types
	if (type == "deaths") {
		if (is.null(adsl)) {
			ph_abort(
				"'adsl' is required for type = 'deaths'. ",
				"Got: NULL"
			)
		}
		adsl <- .ensure_adam_data(adsl, "ADSL")
	}

	if (type == "comparison") {
		if (is.null(adsl)) {
			ph_abort(
				"'adsl' is required for type = 'comparison'. ",
				"Cannot calculate risk differences. Got: NULL"
			)
		}
		if (is.null(ref_group)) {
			trt_levels <- adae@trt_levels
			trt_display <- if (length(trt_levels) > 0) {
				paste(trt_levels, collapse = ", ")
			} else {
				""
			}
			trt_values <- if (nchar(trt_display) > 0) {
				paste0("Available in data: ", trt_display)
			} else {
				""
			}
			ph_abort(
				"'ref_group' is required for type = 'comparison'. ",
				"Specify which treatment to use as reference. ",
				trt_values
			)
		}
		adsl <- .ensure_adam_data(adsl, "ADSL")
	}

	# Validate required columns for trt_n derivation when adsl not provided
	if (is.null(adsl)) {
		ph_warn(
			"adsl not provided; deriving trt_n from subjects with TEAEs in adae. ",
			"This may underestimate safety population ",
			"(excludes subjects without TEAEs). ",
			"Provide adsl for accurate safety population counts.",
			call. = FALSE
		)
	}

	# Get treatment counts - prefer from adsl if available
	trt_n <- if (!is.null(adsl)) {
		# adsl is already ADaMData if it was provided for deaths/comparison type
		# or ensure it's ADaMData
		if (!S7::S7_inherits(adsl, ADaMData)) {
			adsl <- ADaMData(data = adsl, domain = "ADSL")
		}
		adsl@trt_n
	} else {
		# Derive trt_n from adae when adsl not provided
		adae@filtered_data |>
			dplyr::filter(.data$TRTEMFL == "Y") |>
			dplyr::summarise(
				N = dplyr::n_distinct(.data$USUBJID),
				.by = dplyr::all_of(trt_var)
			)
	}
		adsl <- .ensure_adam_data(adsl, "ADSL")
	}

	if (type == "comparison") {
		if (is.null(adsl)) {
			ph_abort(
				"'adsl' is required for type = 'comparison'. ",
				"Cannot calculate risk differences. Got: NULL"
			)
		}
		if (is.null(ref_group)) {
			trt_levels <- adae@trt_levels
			trt_display <- if (length(trt_levels) > 0) {
				paste(trt_levels, collapse = ", ")
			} else {
				""
			}
			trt_values <- if (nchar(trt_display) > 0) {
				paste0("Available in data: ", trt_display)
			} else {
				""
			}
			ph_abort(
				"'ref_group' is required for type = 'comparison'. ",
				"Specify which treatment to use as reference. ",
				trt_values
			)
		}
		adsl <- .ensure_adam_data(adsl, "ADSL")
	}

	# Validate required columns for trt_n derivation when adsl not provided
	if (is.null(adsl)) {
		ph_warn(
			"adsl not provided; deriving trt_n from subjects with TEAEs in adae. ",
			"This may underestimate the safety population ",
			"(excludes subjects without TEAEs). ",
			"Provide adsl for accurate safety population counts.",
			call. = FALSE
		)
	}

	# Get treatment counts - prefer from adsl if available
	trt_n <- if (!is.null(adsl)) {
		adsl@trt_n
	} else {
		adae@filtered_data |>
			dplyr::filter(.data$TRTEMFL == "Y") |>
			dplyr::summarise(
				N = dplyr::n_distinct(.data$USUBJID),
				.by = dplyr::all_of(trt_var)
			)
	}

	# Auto-generate title if not provided (for non-comparison types)
	# comparison type handles its own title generation
	if (is.null(title) && type != "comparison") {
		title <- switch(
			type,
			overview = "Overview of Adverse Events",
			soc = "Adverse Events by System Organ Class",
			soc_pt = "Adverse Events by System Organ Class and Preferred Term",
			pt = if (!is.null(soc)) soc else "Adverse Events by Preferred Term",
			common = sprintf("Most Common Adverse Events (Top %d)", n_top),
			severity = "Subjects by Maximum Adverse Event Severity",
			relationship = "Adverse Events by Relationship to Study Drug",
			sae = "Serious Adverse Events",
			discontinuation = "Adverse Events Leading to Study Drug Discontinuation",
			deaths = "Deaths Summary"
		)
	}

	# Dispatch to appropriate handler
	result <- switch(
		type,
		overview = create_ae_table_overview(
			adae = adae,
			trt_n = trt_n,
			trt_var = trt_var,
			title = title,
			footnotes = footnotes,
			theme = theme,
			...
		),
		soc = create_ae_table_soc(
			adae = adae,
			trt_n = trt_n,
			trt_var = trt_var,
			title = title,
			footnotes = footnotes,
			theme = theme,
			soc_order = soc_order,
			...
		),
		soc_pt = create_ae_table_soc_pt(
			adae = adae,
			trt_n = trt_n,
			trt_var = trt_var,
			title = title,
			footnotes = footnotes,
			theme = theme,
			soc_order = soc_order,
			...
		),
		pt = create_ae_table_pt(
			adae = adae,
			trt_n = trt_n,
			trt_var = trt_var,
			soc = soc,
			title = title,
			footnotes = footnotes,
			theme = theme,
			...
		),
		common = create_ae_table_common(
			adae = adae,
			trt_n = trt_n,
			trt_var = trt_var,
			n_top = n_top,
			title = title,
			footnotes = footnotes,
			theme = theme,
			...
		),
		severity = create_ae_table_severity(
			adae = adae,
			trt_n = trt_n,
			trt_var = trt_var,
			title = title,
			footnotes = footnotes,
			theme = theme,
			severity_levels = severity_levels,
			...
		),
		relationship = create_ae_table_relationship(
			adae = adae,
			trt_n = trt_n,
			trt_var = trt_var,
			title = title,
			footnotes = footnotes,
			theme = theme,
			...
		),
		sae = create_ae_table_sae(
			adae = adae,
			trt_n = trt_n,
			trt_var = trt_var,
			title = title,
			footnotes = footnotes,
			theme = theme,
			...
		),
		discontinuation = create_ae_table_discontinuation(
			adae = adae,
			trt_n = trt_n,
			trt_var = trt_var,
			title = title,
			footnotes = footnotes,
			theme = theme,
			...
		),
		deaths = create_ae_table_deaths(
			adsl = adsl,
			trt_var = trt_var,
			title = title,
			footnotes = footnotes,
			theme = theme,
			...
		),
		comparison = create_ae_comparison_table(
			adae = adae@data,
			adsl = adsl@data,
			ref_group = ref_group,
			trt_var = trt_var,
			by = by,
			threshold = threshold,
			sort_by = sort_by,
			conf_level = conf_level,
			include_nnh = include_nnh,
			title = title,
			autofit = TRUE
		)
	)

	result
}

# Internal handler functions for create_ae_summary_table ----

#' @keywords internal
create_ae_table_overview <- function(
	adae,
	trt_n,
	trt_var,
	title,
	footnotes,
	theme,
	...
) {
	# Ensure adae is ADaMData
	if (!S7::S7_inherits(adae, ADaMData)) {
		adae <- ADaMData(data = adae, domain = "ADAE")
	}

	summarize_category <- function(data, category_label) {
		if (nrow(data) == 0) {
			return(NULL)
		}
		data |>
			dplyr::summarise(
				n = dplyr::n_distinct(.data$USUBJID),
				.by = dplyr::all_of(trt_var)
			) |>
			dplyr::left_join(trt_n, by = trt_var) |>
			dplyr::mutate(
				pct = dplyr::if_else(
					.data$N == 0,
					NA_real_,
					round(.data$n / .data$N * 100, 1)
				)
			) |>
			dplyr::mutate(Category = category_label)
	}

	teae_data <- adae@filtered_data

	categories <- list()

	if ("TRTEMFL" %in% names(teae_data)) {
		teae <- teae_data |> dplyr::filter(.data$TRTEMFL == "Y")
		categories[[1]] <- summarize_category(
			teae,
			"Subjects with at least one TEAE"
		)
	}

	if ("TRTEMFL" %in% names(teae_data) && "AEREL" %in% names(teae_data)) {
		rel_teae <- teae_data |>
			dplyr::filter(
				.data$TRTEMFL == "Y",
				.data$AEREL %in% AEREL_RELATED_VALUES
			)
		categories[[2]] <- summarize_category(
			rel_teae,
			"Subjects with at least one related TEAE"
		)
	}

	if ("TRTEMFL" %in% names(teae_data) && "AESER" %in% names(teae_data)) {
		sae <- teae_data |> dplyr::filter(.data$TRTEMFL == "Y", .data$AESER == "Y")
		categories[[3]] <- summarize_category(sae, "Subjects with at least one SAE")
	}

	if ("TRTEMFL" %in% names(teae_data) && "AEACN" %in% names(teae_data)) {
		disc <- teae_data |>
			dplyr::filter(.data$TRTEMFL == "Y", .data$AEACN == AEACN_DRUG_WITHDRAWN)
		categories[[4]] <- summarize_category(
			disc,
			"Subjects with AE leading to discontinuation"
		)
	}

	if ("TRTEMFL" %in% names(teae_data) && "AEOUT" %in% names(teae_data)) {
		fatal <- teae_data |>
			dplyr::filter(.data$TRTEMFL == "Y", .data$AEOUT == "FATAL")
		categories[[5]] <- summarize_category(fatal, "Deaths")
	}

	overview_combined <- dplyr::bind_rows(categories)

	if (nrow(overview_combined) == 0) {
		ph_warn("No adverse event data found matching criteria", call. = FALSE)
		return(NULL)
	}

	overview_formatted <- overview_combined |>
		dplyr::mutate(
			value = dplyr::case_when(
				is.na(.data$pct) ~ "--",
				TRUE ~ sprintf("%d (%.1f%%)", .data$n, .data$pct)
			)
		) |>
		dplyr::select("Category", dplyr::all_of(trt_var), "value") |>
		tidyr::pivot_wider(
			names_from = dplyr::all_of(trt_var),
			values_from = "value",
			values_fill = "0 (0.0%)"
		)

	create_clinical_table(
		data = overview_formatted,
		type = "ae_overview",
		title = title,
		footnotes = footnotes,
		theme = theme,
		...
	)
}

#' @keywords internal
create_ae_table_soc <- function(
	adae,
	trt_n,
	trt_var,
	title,
	footnotes,
	theme,
	soc_order = NULL,
	...
) {
	# Ensure adae is ADaMData
	if (!S7::S7_inherits(adae, ADaMData)) {
		adae <- ADaMData(data = adae, domain = "ADAE")
	}

	teae_data <- adae@filtered_data |>
		dplyr::filter(.data$TRTEMFL == "Y")

	soc_summary <- teae_data |>
		dplyr::summarise(
			n_subj = dplyr::n_distinct(.data$USUBJID),
			.by = c(dplyr::all_of(trt_var), "AEBODSYS")
		) |>
		dplyr::left_join(trt_n, by = trt_var) |>
		dplyr::mutate(
			pct = dplyr::if_else(
				.data$N == 0 | is.na(.data$N),
				NA_real_,
				round(.data$n_subj / .data$N * 100, 1)
			),
			display = dplyr::if_else(
				is.na(.data$pct),
				paste0(.data$n_subj, " (--)"),
				paste0(.data$n_subj, " (", .data$pct, "%)")
			)
		) |>
		dplyr::select("AEBODSYS", dplyr::all_of(trt_var), "display") |>
		tidyr::pivot_wider(
			names_from = dplyr::all_of(trt_var),
			values_from = "display",
			values_fill = "0 (0.0%)"
		) |>
		dplyr::rename(`System Organ Class` = "AEBODSYS")

	# Apply custom SOC ordering if provided
	if (!is.null(soc_order)) {
		observed_socs <- unique(soc_summary$`System Organ Class`)
		soc_levels <- c(
			soc_order[soc_order %in% observed_socs],
			setdiff(observed_socs, soc_order)
		)
		soc_summary <- soc_summary |>
			dplyr::mutate(
				`System Organ Class` = factor(
					.data$`System Organ Class`,
					levels = soc_levels
				)
			) |>
			dplyr::arrange(.data$`System Organ Class`) |>
			dplyr::mutate(
				`System Organ Class` = as.character(.data$`System Organ Class`)
			)
	} else {
		soc_summary <- soc_summary |> dplyr::arrange(.data$`System Organ Class`)
	}

	create_clinical_table(
		data = soc_summary,
		type = "ae_soc",
		title = title,
		footnotes = c(
			footnotes,
			"Safety Population",
			"n (%) = Number (percentage) of subjects with at least one event"
		),
		theme = theme,
		...
	)
}

#' @keywords internal
create_ae_table_soc_pt <- function(
	adae,
	trt_n,
	trt_var,
	title,
	footnotes,
	theme,
	soc_order = NULL,
	...
) {
	# Ensure adae is ADaMData
	if (!S7::S7_inherits(adae, ADaMData)) {
		adae <- ADaMData(data = adae, domain = "ADAE")
	}

	teae_data <- adae@filtered_data |>
		dplyr::filter(.data$TRTEMFL == "Y")

	soc_pt_summary <- teae_data |>
		dplyr::summarise(
			n_subj = dplyr::n_distinct(.data$USUBJID),
			.by = c(dplyr::all_of(trt_var), "AEBODSYS", "AEDECOD")
		) |>
		dplyr::left_join(trt_n, by = trt_var) |>
		dplyr::mutate(
			pct = dplyr::if_else(
				.data$N == 0 | is.na(.data$N),
				NA_real_,
				round(.data$n_subj / .data$N * 100, 1)
			),
			display = dplyr::if_else(
				is.na(.data$pct),
				paste0(.data$n_subj, " (--)"),
				paste0(.data$n_subj, " (", .data$pct, "%)")
			)
		) |>
		dplyr::select("AEBODSYS", "AEDECOD", dplyr::all_of(trt_var), "display") |>
		tidyr::pivot_wider(
			names_from = dplyr::all_of(trt_var),
			values_from = "display",
			values_fill = "0 (0.0%)"
		) |>
		dplyr::rename(
			`System Organ Class` = "AEBODSYS",
			`Preferred Term` = "AEDECOD"
		)

	# Apply custom SOC ordering if provided
	if (!is.null(soc_order)) {
		observed_socs <- unique(soc_pt_summary$`System Organ Class`)
		soc_levels <- c(
			soc_order[soc_order %in% observed_socs],
			setdiff(observed_socs, soc_order)
		)
		soc_pt_summary <- soc_pt_summary |>
			dplyr::mutate(
				`System Organ Class` = factor(
					.data$`System Organ Class`,
					levels = soc_levels
				)
			) |>
			dplyr::arrange(.data$`System Organ Class`, .data$`Preferred Term`) |>
			dplyr::mutate(
				`System Organ Class` = as.character(.data$`System Organ Class`)
			)
	} else {
		soc_pt_summary <- soc_pt_summary |>
			dplyr::arrange(.data$`System Organ Class`, .data$`Preferred Term`)
	}

	create_clinical_table(
		data = soc_pt_summary,
		type = "ae_soc_pt",
		title = title,
		footnotes = c(
			footnotes,
			"Safety Population",
			"n (%) = Number (percentage) of subjects with at least one event"
		),
		theme = theme,
		...
	)
}

#' @keywords internal
create_ae_table_pt <- function(
	adae,
	trt_n,
	trt_var,
	soc,
	title,
	footnotes,
	theme,
	...
) {
	# Ensure adae is ADaMData
	if (!S7::S7_inherits(adae, ADaMData)) {
		adae <- ADaMData(data = adae, domain = "ADAE")
	}

	teae_data <- adae@filtered_data |>
		dplyr::filter(.data$TRTEMFL == "Y")

	if (!is.null(soc)) {
		teae_data <- teae_data |> dplyr::filter(.data$AEBODSYS == soc)
	}

	pt_summary <- teae_data |>
		dplyr::summarise(
			n_subj = dplyr::n_distinct(.data$USUBJID),
			.by = c(dplyr::all_of(trt_var), "AEDECOD")
		) |>
		dplyr::left_join(trt_n, by = trt_var) |>
		dplyr::mutate(
			pct = dplyr::if_else(
				.data$N == 0 | is.na(.data$N),
				NA_real_,
				round(.data$n_subj / .data$N * 100, 1)
			),
			display = dplyr::if_else(
				is.na(.data$pct),
				paste0(.data$n_subj, " (--)"),
				paste0(.data$n_subj, " (", .data$pct, "%)")
			)
		) |>
		dplyr::select("AEDECOD", dplyr::all_of(trt_var), "display") |>
		tidyr::pivot_wider(
			names_from = dplyr::all_of(trt_var),
			values_from = "display",
			values_fill = "0 (0.0%)"
		) |>
		dplyr::rename(`Preferred Term` = "AEDECOD") |>
		dplyr::arrange(.data$`Preferred Term`)

	create_clinical_table(
		data = pt_summary,
		type = "ae_pt",
		title = title,
		footnotes = footnotes,
		theme = theme,
		...
	)
}

#' @keywords internal
create_ae_table_common <- function(
	adae,
	trt_n,
	trt_var,
	n_top,
	title,
	footnotes,
	theme,
	...
) {
	# Ensure adae is ADaMData
	if (!S7::S7_inherits(adae, ADaMData)) {
		adae <- ADaMData(data = adae, domain = "ADAE")
	}

	teae_data <- adae@filtered_data |>
		dplyr::filter(.data$TRTEMFL == "Y")

	top_pts <- teae_data |>
		dplyr::summarise(
			n = dplyr::n_distinct(.data$USUBJID),
			.by = "AEDECOD"
		) |>
		dplyr::arrange(dplyr::desc(.data$n)) |>
		dplyr::slice_head(n = n_top) |>
		dplyr::pull(.data$AEDECOD)

	common_summary <- teae_data |>
		dplyr::filter(.data$AEDECOD %in% top_pts) |>
		dplyr::summarise(
			n_subj = dplyr::n_distinct(.data$USUBJID),
			.by = c(dplyr::all_of(trt_var), "AEBODSYS", "AEDECOD")
		) |>
		dplyr::left_join(trt_n, by = trt_var) |>
		dplyr::mutate(
			pct = dplyr::if_else(
				.data$N == 0 | is.na(.data$N),
				NA_real_,
				round(.data$n_subj / .data$N * 100, 1)
			),
			display = dplyr::if_else(
				is.na(.data$pct),
				paste0(.data$n_subj, " (--)"),
				paste0(.data$n_subj, " (", .data$pct, "%)")
			)
		) |>
		dplyr::select("AEBODSYS", "AEDECOD", dplyr::all_of(trt_var), "display") |>
		tidyr::pivot_wider(
			names_from = dplyr::all_of(trt_var),
			values_from = "display",
			values_fill = "0 (0.0%)"
		) |>
		dplyr::rename(
			`System Organ Class` = "AEBODSYS",
			`Preferred Term` = "AEDECOD"
		) |>
		dplyr::arrange(.data$`System Organ Class`, .data$`Preferred Term`)

	create_clinical_table(
		data = common_summary,
		type = "ae_common",
		title = title,
		footnotes = c(
			footnotes,
			"Safety Population",
			sprintf("Showing top %d most frequently reported Preferred Terms", n_top)
		),
		theme = theme,
		...
	)
}

#' @keywords internal
create_ae_table_severity <- function(
	adae,
	trt_n,
	trt_var,
	title,
	footnotes,
	theme,
	severity_levels = c("MILD", "MODERATE", "SEVERE"),
	...
) {
	# Ensure adae is ADaMData
	if (!S7::S7_inherits(adae, ADaMData)) {
		adae <- ADaMData(data = adae, domain = "ADAE")
	}

	teae_data <- adae@filtered_data |>
		dplyr::filter(.data$TRTEMFL == "Y")

	# Validate AESEV values match expected levels
	if ("AESEV" %in% names(teae_data)) {
		observed_sev <- unique(teae_data$AESEV)
		unmatched <- setdiff(observed_sev, c(severity_levels, NA))
		if (length(unmatched) > 0) {
			ph_warn(
				sprintf(
					"AESEV values %s not in severity_levels and will be treated as NA",
					paste(unmatched, collapse = ", ")
				)
			)
		}

		severity_summary <- teae_data |>
			dplyr::mutate(
				AESEV_ord = factor(
					.data$AESEV,
					levels = severity_levels,
					ordered = TRUE
				)
			) |>
			dplyr::summarise(
				max_sev = as.character(max(.data$AESEV_ord, na.rm = TRUE)),
				.by = c(dplyr::all_of(trt_var), "USUBJID")
			) |>
			dplyr::mutate(
				max_sev = dplyr::if_else(
					.data$max_sev == "-Inf",
					NA_character_,
					.data$max_sev
				)
			) |>
			dplyr::filter(!is.na(.data$max_sev)) |>
			dplyr::summarise(
				n = dplyr::n(),
				.by = c(dplyr::all_of(trt_var), "max_sev")
			) |>
			dplyr::left_join(trt_n, by = trt_var) |>
			dplyr::mutate(
				pct = dplyr::if_else(
					.data$N == 0 | is.na(.data$N),
					NA_real_,
					round(.data$n / .data$N * 100, 1)
				),
				display = dplyr::if_else(
					is.na(.data$pct),
					paste0(.data$n, " (--)"),
					paste0(.data$n, " (", .data$pct, "%)")
				)
			) |>
			dplyr::select("max_sev", dplyr::all_of(trt_var), "display") |>
			tidyr::pivot_wider(
				names_from = dplyr::all_of(trt_var),
				values_from = "display",
				values_fill = "0 (0.0%)"
			) |>
			dplyr::rename(`Maximum Severity` = "max_sev")

		create_clinical_table(
			data = severity_summary,
			type = "ae_severity",
			title = title,
			footnotes = c(
				footnotes,
				"Safety Population",
				"Maximum severity across all TEAEs per subject"
			),
			theme = theme,
			...
		)
	} else {
		# No AESEV column
		summary_df <- data.frame(
			Message = "AESEV column not found in data"
		)

		create_clinical_table(
			data = summary_df,
			type = "ae_severity",
			title = title,
			footnotes = footnotes,
			theme = theme,
			...
		)
	}
}

#' @keywords internal
create_ae_table_relationship <- function(
	adae,
	trt_n,
	trt_var,
	title,
	footnotes,
	theme,
	...
) {
	# Ensure adae is ADaMData
	if (!S7::S7_inherits(adae, ADaMData)) {
		adae <- ADaMData(data = adae, domain = "ADAE")
	}

	teae_data <- adae@filtered_data |>
		dplyr::filter(.data$TRTEMFL == "Y")

	# Shows all AEREL categories including NA/unknown
	rel_summary <- teae_data |>
		dplyr::summarise(
			n_subj = dplyr::n_distinct(.data$USUBJID),
			.by = c(dplyr::all_of(trt_var), "AEREL")
		) |>
		dplyr::left_join(trt_n, by = trt_var) |>
		dplyr::mutate(
			pct = dplyr::if_else(
				.data$N == 0 | is.na(.data$N),
				NA_real_,
				round(.data$n_subj / .data$N * 100, 1)
			),
			display = dplyr::if_else(
				is.na(.data$pct),
				paste0(.data$n_subj, " (--)"),
				paste0(.data$n_subj, " (", .data$pct, "%)")
			)
		) |>
		dplyr::select("AEREL", dplyr::all_of(trt_var), "display") |>
		tidyr::pivot_wider(
			names_from = dplyr::all_of(trt_var),
			values_from = "display",
			values_fill = "0 (0.0%)"
		) |>
		dplyr::rename(`Relationship to Study Drug` = "AEREL")

	create_clinical_table(
		data = rel_summary,
		type = "ae_relationship",
		title = title,
		footnotes = c(
			footnotes,
			"Safety Population",
			"Subjects counted once per relationship category"
		),
		theme = theme,
		...
	)
}

#' @keywords internal
create_ae_table_sae <- function(
	adae,
	trt_n,
	trt_var,
	title,
	footnotes,
	theme,
	...
) {
	# Ensure adae is ADaMData
	if (!S7::S7_inherits(adae, ADaMData)) {
		adae <- ADaMData(data = adae, domain = "ADAE")
	}

	teae_data <- adae@filtered_data
	sae <- teae_data |> dplyr::filter(.data$TRTEMFL == "Y", .data$AESER == "Y")

	if (nrow(sae) == 0) {
		summary_df <- data.frame(
			Message = "No serious adverse events reported during the study"
		)
	} else {
		summary_df <- sae |>
			dplyr::summarise(
				n_subj = dplyr::n_distinct(.data$USUBJID),
				.by = c(dplyr::all_of(trt_var), "AEBODSYS", "AEDECOD")
			) |>
			dplyr::left_join(trt_n, by = trt_var) |>
			dplyr::mutate(
				pct = dplyr::if_else(
					.data$N == 0 | is.na(.data$N),
					NA_real_,
					round(.data$n_subj / .data$N * 100, 1)
				),
				display = dplyr::if_else(
					is.na(.data$pct),
					paste0(.data$n_subj, " (--)"),
					paste0(.data$n_subj, " (", .data$pct, "%)")
				)
			) |>
			dplyr::select("AEBODSYS", "AEDECOD", dplyr::all_of(trt_var), "display") |>
			tidyr::pivot_wider(
				names_from = dplyr::all_of(trt_var),
				values_from = "display",
				values_fill = "0 (0.0%)"
			) |>
			dplyr::rename(
				`System Organ Class` = "AEBODSYS",
				`Preferred Term` = "AEDECOD"
			) |>
			dplyr::arrange(.data$`System Organ Class`, .data$`Preferred Term`)
	}

	create_clinical_table(
		data = summary_df,
		type = "ae_sae",
		title = title,
		footnotes = c(
			footnotes,
			"Safety Population",
			"SAE = Serious Adverse Event (AESER = 'Y')"
		),
		theme = theme,
		...
	)
}

#' @keywords internal
create_ae_table_discontinuation <- function(
	adae,
	trt_n,
	trt_var,
	title,
	footnotes,
	theme,
	...
) {
	# Ensure adae is ADaMData
	if (!S7::S7_inherits(adae, ADaMData)) {
		adae <- ADaMData(data = adae, domain = "ADAE")
	}

	teae_data <- adae@filtered_data
	disc <- teae_data |>
		dplyr::filter(.data$TRTEMFL == "Y", .data$AEACN == AEACN_DRUG_WITHDRAWN)

	if (nrow(disc) == 0) {
		summary_df <- data.frame(
			Message = "No adverse events leading to study drug discontinuation"
		)
	} else {
		summary_df <- disc |>
			dplyr::summarise(
				n_subj = dplyr::n_distinct(.data$USUBJID),
				.by = c(dplyr::all_of(trt_var), "AEBODSYS", "AEDECOD")
			) |>
			dplyr::left_join(trt_n, by = trt_var) |>
			dplyr::mutate(
				pct = dplyr::if_else(
					.data$N == 0 | is.na(.data$N),
					NA_real_,
					round(.data$n_subj / .data$N * 100, 1)
				),
				display = dplyr::if_else(
					is.na(.data$pct),
					paste0(.data$n_subj, " (--)"),
					paste0(.data$n_subj, " (", .data$pct, "%)")
				)
			) |>
			dplyr::select("AEBODSYS", "AEDECOD", dplyr::all_of(trt_var), "display") |>
			tidyr::pivot_wider(
				names_from = dplyr::all_of(trt_var),
				values_from = "display",
				values_fill = "0 (0.0%)"
			) |>
			dplyr::rename(
				`System Organ Class` = "AEBODSYS",
				`Preferred Term` = "AEDECOD"
			) |>
			dplyr::arrange(.data$`System Organ Class`, .data$`Preferred Term`)
	}

	create_clinical_table(
		data = summary_df,
		type = "ae_discontinuation",
		title = title,
		footnotes = c(footnotes, "Safety Population", "AEACN = 'DRUG WITHDRAWN'"),
		theme = theme,
		...
	)
}

#' @keywords internal
create_ae_table_deaths <- function(
	adsl,
	trt_var,
	title,
	footnotes,
	theme,
	...
) {
	# Ensure adsl is ADaMData
	if (!S7::S7_inherits(adsl, ADaMData)) {
		adsl <- ADaMData(data = adsl, domain = "ADSL")
	}

	safety_data <- adsl@filtered_data

	death_summary <- safety_data |>
		dplyr::filter(.data$SAFFL == "Y") |>
		dplyr::summarise(
			N = dplyr::n(),
			n_deaths = sum(.data$DTHFL == "Y", na.rm = TRUE),
			.by = dplyr::all_of(trt_var)
		) |>
		dplyr::mutate(
			pct = dplyr::if_else(
				.data$N == 0 | is.na(.data$N),
				NA_real_,
				round(.data$n_deaths / .data$N * 100, 1)
			),
			`Deaths n (%)` = dplyr::if_else(
				is.na(.data$pct),
				paste0(.data$n_deaths, " (--)"),
				paste0(.data$n_deaths, " (", .data$pct, "%)")
			),
			N = as.character(.data$N)
		) |>
		dplyr::select(dplyr::all_of(trt_var), "N", "Deaths n (%)")

	death_wide <- death_summary |>
		tidyr::pivot_longer(
			cols = c("N", "Deaths n (%)"),
			names_to = "Statistic",
			values_to = "Value"
		) |>
		tidyr::pivot_wider(
			names_from = dplyr::all_of(trt_var),
			values_from = "Value"
		) |>
		dplyr::mutate(
			Statistic = dplyr::case_when(
				.data$Statistic == "N" ~ "Safety Population (N)",
				TRUE ~ .data$Statistic
			)
		)

	create_clinical_table(
		data = death_wide,
		type = "ae_deaths",
		title = title,
		footnotes = c(footnotes, "Safety Population", "DTHFL = 'Y'"),
		theme = theme,
		...
	)
}
